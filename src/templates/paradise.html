{% extends "base.html" %}
{% block content %}
<div id="sigma_graph"></div>
{% endblock %}
{% block includes %} {{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='js/sigma.min.js') }}"></script>
<script type="text/javascript">
function lerp(a, z, p){
  return a + (z-a)* p;
}

function ilerp(a, z, p){
  return Math.round(lerp(a,z,p));
}

function rlerp(a,z,p){
  return ilerp(a, z, Math.random());
}

function getHSL(h, s, l) {
    var ret = 'hsl(' + h + ',' + s + '%,' + l + '%)';
    //console.log(h,s,l, ret);
    return ret;
}


var GOLDEN_RATIO = (1 + Math.sqrt(5)) / 2;
var GOLDEN_RATIO_CONJUGATE = 1 - GOLDEN_RATIO;
var LAST_NUMBER = 0;

function getColor(last) {
    if (last != LAST_NUMBER) {
        console.log("Number changed", LAST_NUMBER);
        LAST_NUMBER = last;
    }

    var last = (last + GOLDEN_RATIO_CONJUGATE) % 1;
    return getHSL(ilerp(0,360,last),    // hue
                80,                     // saturation
                last == 0 ? 10 : 80                      // lightness
    );
}
function getColorHex(role_id) {
        var base_num = role_id;
        if (base_num < 4473924) {
            base_num += 333333;
        }
        if (base_num % 3 == 0) {
            base_num += 7000;
        }
        if (base_num % 5 == 0) {
            base_num += 2000;
        }
        var hex_val = base_num.toString(16);
        var new_str = hex_val;
        for (i=0; i < (6 - hex_val.length); i++) {
            new_str = new_str + hex_val[(hex_val.length - 1) - i];
        }
        return "#" + new_str;
    }
</script>
<script type="text/javascript">
$(function() {
    var sigRoot = document.getElementById('sigma_graph');
    var sigInst = sigma.init(sigRoot);

    sigInst.drawingProperties({
        defaultLabelColor: '#ccc',
        font: 'Arial',
        edgeColor: 'target',
        //defaultEdgeType: 'curve'
    }).graphProperties({
        minNodeSize: 1,
        maxNodeSize: 8
    }).mouseProperties({
        maxRatio: 32
    });

    var data = {{ items|tojson|safe }};

    // Create all nodes
    for (var key in data) {
        sigInst.addNode(key, {
            x: data[key].x,
            y: data[key].y,
            size: parseInt(data[key]["security"]),
            color: getColorHex(parseInt(data[key]["security"])),
            label: data[key]["name"]
        });
    }
    // Create all edges
    for (var key in data) {
        // data[key]["data"] is a list of links to data[key]
        try {
            sigInst.addEdge(key + "_" + data[key]["parent"], key, data[key]["parent"]);
        } catch(err) {
        }
    }
    var greyColor = '#666';

    sigInst.draw();
    sigInst.bind('overnodes',function(event){
        var nodes = event.content;
        var neighbors = {};
        sigInst.iterEdges(function(e){
            if(nodes.indexOf(e.source)>=0 || nodes.indexOf(e.target)>=0){
                neighbors[e.source] = 1;
                neighbors[e.target] = 1;
            }
        }).iterNodes(function(n){
            if(!neighbors[n.id]){
                n.hidden = 1;
            }else{
                n.hidden = 0;
            }
        }).draw(2,2,2);
    }).bind('outnodes',function(){
        sigInst.iterEdges(function(e){
            e.hidden = 0;
        }).iterNodes(function(n){
            n.hidden = 0;
        }).draw(2,2,2);
    });

});
</script>
{% endblock %}
